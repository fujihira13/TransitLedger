# 交通費・交際費ログアプリ 要件定義書（MVP）
**対象**：個人向け / ログインなし  
**技術**：React + PWA（ローカルファースト）  
**保存方式（MVP）**：`localStorage`  
**バックアップ復元（MVP）**：JSONインポート時に**全削除して完全復元**（置き換え）  
**満足度**：支出1件ごとに **1〜5（整数）**

---

## 1. 目的・背景
交通費と交際費（食事/カラオケ/部屋代など）を**最短入力**で記録し、月次で把握できるようにする。  
「入力が面倒で続かない」を避け、**継続しやすい導線**を最優先する。

### 1.1 ゴール（KPI）
- 追加（新規登録）1件あたりの入力：**平均10秒以内**を目標
- スマホ操作：**3〜6タップ程度**で保存できる導線
- 今月の合計（交通費/交際費/合計）が**即座に見える**

---

## 2. 想定利用環境
- **スマホ優先**（iOS Safari / Android Chrome）
- PCブラウザ（Chrome等）は補助
- PWAとしてホーム画面追加できること（オフラインでも利用可能）

---

## 3. スコープ
### 3.1 MVPに含める
- 支出の追加（テンプレ/前回引継ぎ/頻出金額候補を含む）
- 一覧表示（編集/削除、月・区分・サブ区分フィルタ）
- 集計（今月合計・内訳・期間指定）
- “気づき”（最低限の軽い分析）
- 設定（テンプレ編集、CSV出力、JSONバックアップ/復元）
- ローカル保存（localStorage）

### 3.2 MVPから除外（後回し）
- クラウド同期/ログイン
- レシート撮影・OCR
- 複数通貨、複数ユーザー
- 高度な検索（全文検索、複雑なタグフィルタ）

---

## 4. 画面構成
1. **追加**（テンプレ＋最小入力）  
2. **一覧**（ログ閲覧、フィルタ、編集/削除）  
3. **集計**（今月/先月/期間指定、内訳、気づき）  
4. **設定**（テンプレ編集、エクスポート/バックアップ/復元）

> 画面遷移はシンプルにし、追加画面へすぐ戻れる導線を常設する（フッタタブ等を想定）。

---

## 5. 機能要件

## 5.1 支出追加（最短入力）
### 5.1.1 入力項目
|項目|必須|形式|デフォルト|備考|
|---|---:|---|---|---|
|日付|必須|YYYY-MM-DD|今日|変更可|
|金額|必須|整数（円）|空|1以上|
|区分|必須|transport / social|前回値|2択|
|サブ区分|必須|後述の候補|前回値|タップ選択|
|メモ|任意|1行テキスト|前回値|店名/区間など|
|満足度|任意（推奨）|1〜5整数|空|★UIなど|

> **満足度は“任意”**として、入力負担を増やしすぎない（ただし継続利用で価値が出るため推奨）。

### 5.1.2 区分・サブ区分
- 区分（category）
  - `transport`（交通費）
  - `social`（交際費）
- サブ区分（subcategory）
  - transport：`train` / `bus` / `taxi` / `parking` / `other`
  - social：`meal` / `cafe` / `drink` / `karaoke` / `room` / `other`

### 5.1.3 入力最適化
- **前回入力の引き継ぎ**
  - 保存成功後、次回追加時に `category/subcategory/memo` を前回値で初期表示
- **よく使う金額候補**
  - 直近N件または直近X日から金額の頻出上位を抽出し、チップ表示（例：上位5件）
  - チップをタップすると金額入力へ反映
- **ワンタップテンプレ**
  - テンプレは「区分＋サブ区分＋（任意）金額＋（任意）メモ雛形」
  - 追加画面上部に並べ、タップでフォームへ反映
  - 反映後、ユーザーが金額だけ入れて即保存できる

### 5.1.4 保存時バリデーション
- date：YYYY-MM-DD、存在する日付であること
- amount：整数、1以上（0不可）
- category：transport / social のいずれか
- subcategory：categoryに対応した候補のいずれか
- memo：最大文字数（例：200）以内
- satisfaction：未入力または 1〜5 の整数

---

## 5.2 一覧（閲覧・編集・削除）
### 5.2.1 一覧表示
- デフォルト：日付降順（最新が上）
- 表示項目：日付 / 金額 / 区分・サブ区分 / メモ（省略）/ 満足度（任意表示）

### 5.2.2 編集
- 1件タップ → 編集画面（またはモーダル）
- 編集可能：全フィールド（日付、金額、区分、サブ区分、メモ、満足度）
- 更新成功後：一覧に戻り、変更が反映される

### 5.2.3 削除
- 削除前に確認ダイアログを表示（誤操作防止）
- 削除成功後：一覧に反映

### 5.2.4 フィルタ（最低限）
- 月：今月 / 先月 / 指定（月選択）
- 区分：交通費 / 交際費
- サブ区分：選択式（区分が未指定の場合は全サブ区分から選択可）

---

## 5.3 集計（見て価値が出る）
### 5.3.1 基本集計
- 今月合計：
  - 交通費合計（transport）
  - 交際費合計（social）
  - 総合計（両方）
- 内訳：サブ区分別合計（リスト表示を基本、円グラフは任意）
- 期間指定集計：開始日〜終了日

### 5.3.2 “気づき”（軽量分析）
- タクシー比率：今月の交通費のうち `taxi` が占める割合
- 交際費のピーク日：交際費合計が多い日 TOP3
- 週次平均：今週 vs 先週（週の開始曜日は設定で変更可能にしてもよい）
- 内訳の偏り：例「mealが交際費のX%」

### 5.3.3 満足度の活用（MVP範囲内）
- 期間内の平均満足度（任意）
- サブ区分別の平均満足度（任意）
> 集計表示に含めるかは実装時に軽く調整可能。まずは入力・保存を優先。

---

## 5.4 設定
### 5.4.1 テンプレ管理
- テンプレの追加/編集/削除
- 並び替え（任意：上下移動でも可）
- テンプレ項目：
  - name（表示名）
  - category
  - subcategory
  - amount（任意）
  - memo_template（任意）

### 5.4.2 データ管理
- CSV出力（期間指定）
- JSONバックアップ（全件）
- JSON復元（完全復元＝置き換え）
- 全削除（任意：危険操作として確認必須）

---

## 5.5 エクスポート/バックアップ/復元
### 5.5.1 CSV出力（期間指定）
- 列：`date,amount,category,subcategory,memo,satisfaction`
- 例：
  - 2026-01-08,1200,social,meal,ランチ,4
  - 2026-01-08,980,transport,train,新宿→渋谷,5

### 5.5.2 JSONバックアップ（全件）
- 対象：expenses / templates / settings / schemaVersion
- 目的：端末の変更やデータ消失への備え

### 5.5.3 JSON復元（MVP仕様：全削除して完全復元）
- 手順：
  1) JSONファイル選択  
  2) 内容の簡易チェック（バージョン/形式）  
  3) **現在のデータを全削除**  
  4) JSONのデータを保存  
- 注意：復元前データは消えるため、確認ダイアログを必須とする

---

## 5.6 PWA要件
- オフラインで以下が動作すること：
  - 追加、一覧、編集、削除、集計（ローカルデータに対して）
- キャッシュ：初回ロード後に基本画面が表示できる程度（シンプルな戦略）
- ホーム画面追加用の manifest を用意

---

## 6. データ設計（MVP / localStorage）

## 6.1 エンティティ
### 6.1.1 expenses
|フィールド|型|必須|例|
|---|---|---:|---|
|id|string(UUID)|必須|"550e8400-e29b-41d4-a716-446655440000"|
|date|string|必須|"2026-01-08"|
|amount|number(int)|必須|980|
|category|string|必須|"transport"|
|subcategory|string|必須|"train"|
|memo|string|null|"新宿→渋谷"|
|satisfaction|number(int)|null|4|
|created_at|string(ISO)|必須|"2026-01-12T10:00:00.000Z"|
|updated_at|string(ISO)|必須|"2026-01-12T10:00:00.000Z"|

### 6.1.2 templates
|フィールド|型|必須|例|
|---|---|---:|---|
|id|string(UUID)|必須|...|
|name|string|必須|"ランチ"|
|category|string|必須|"social"|
|subcategory|string|必須|"meal"|
|amount|number(int)|null|1200|
|memo_template|string|null|"店名: "|
|sort_order|number(int)|必須|10|
|created_at|string(ISO)|必須|...|
|updated_at|string(ISO)|必須|...|

### 6.1.3 settings
- last_used_category: string
- last_used_subcategory: string
- last_used_memo: string
- frequent_amount_limit: number（例：5）
- frequent_amount_window_days: number（例：30）
- week_start: number（例：1=月曜開始）
- schema_version: number

## 6.2 localStorageキー設計（例）
- `te:expenses` … expenses配列（JSON文字列）
- `te:templates` … templates配列（JSON文字列）
- `te:settings` … settingsオブジェクト（JSON文字列）

> **将来移行を容易にするため**、アプリ内では `StorageAdapter`（保存窓口）を通して読み書きすること。  
> localStorage直呼びは避ける。

---

## 7. 受け入れ基準（Acceptance Criteria）

## 7.1 追加
- 今日の日付が初期表示される
- 金額・区分・サブ区分が揃っていない場合は保存できない
- 保存後、一覧に即反映される
- 保存後、次回追加画面に前回の区分/サブ区分/メモが引き継がれる

## 7.2 一覧・編集・削除
- 月フィルタで今月/先月/指定月の表示が切り替わる
- 区分・サブ区分フィルタが機能する
- 編集保存で更新される
- 削除は確認後に実行され、一覧から消える

## 7.3 集計
- 今月の「交通費合計/交際費合計/合計」が一致する
- サブ区分別の内訳合計の総和が該当区分の合計と一致する
- 期間指定で指定範囲の集計になる

## 7.4 エクスポート/バックアップ/復元
- CSVを期間指定で出力できる（列が仕様通り）
- JSONバックアップを出力できる
- JSON復元で「現在のデータが全削除され、JSONの内容に置き換わる」
- JSON形式が不正な場合、復元せずエラー表示される

---

## 8. 非機能要件
- パフォーマンス：一覧・集計は体感待ちなし（MVP想定件数：数百〜数千件）
- 信頼性：保存失敗時はユーザーに明確に通知
- プライバシー：データは端末内（localStorage）に保存。外部送信なし
- データ消失リスク：ブラウザデータ削除・OS都合等で消える可能性を設定画面に明記
- アクセシビリティ：タップ領域、フォーカス、最低限のキーボード操作

---

## 9. 将来拡張（ロードマップ案）
- 保存方式を IndexedDB（Dexie）へ移行（件数増加/安定性向上）
- タグ（旅行/通勤/仕事など）
- クラウド同期（任意）
- レポートの充実（満足度×支出の相関、曜日別など）
- 入力支援強化（テンプレのショートカット、音声入力など）

---

## 10. 既知のリスク・制約（MVP）
- localStorageは容量・性能・環境差の影響を受けるため、長期運用で課題が出る可能性がある
- iOS環境等で、条件によってローカルデータが消えるリスクはゼロではない  
  → 対策：**バックアップ導線を目立たせる**（設定画面、初回チュートリアル等）

---

## 付録A：表示ラベル（例）
- category
  - transport：交通費
  - social：交際費
- subcategory
  - train：電車 / bus：バス / taxi：タクシー / parking：駐車場 / other：その他
  - meal：食事 / cafe：カフェ / drink：飲み / karaoke：カラオケ / room：部屋代 / other：その他
