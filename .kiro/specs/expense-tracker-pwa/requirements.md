# 要件定義書

## 概要
本ドキュメントは、交通費・交際費を最短入力で記録するReact+PWAアプリケーション「Expense Tracker PWA」の要件を定義する。ログイン不要でlocalStorageにデータを保存し、一覧管理・月次/期間集計・CSV出力・JSONバックアップ/復元機能を提供する。入力の手軽さを最優先し、継続利用を促進することを目指す。

## プロジェクト説明
交通費・交際費を最短入力で記録し、一覧の編集/削除・月次/期間集計・CSV出力・JSONバックアップと全削除置き換え復元ができる、ログイン不要のReact+PWA（localStorage保存、満足度1〜5）

---

## 要件一覧

### 要件1: 支出の新規登録（最短入力）
**目的:** 交通費・交際費を素早く記録し、入力の手間を最小限に抑えて継続的に支出管理を可能にする

#### 受け入れ条件
1. 追加画面を開いた際、今日の日付をデフォルト値として表示すること
2. 追加画面を開いた際、前回入力した区分・サブ区分・メモを初期値として表示すること
3. 金額入力欄を選択した際、頻出金額候補をチップとして表示すること（詳細は「頻出金額候補の仕様」参照）
4. 金額チップをタップした際、タップした金額を金額入力欄に反映すること
5. テンプレをタップした際、テンプレの区分・サブ区分・金額（設定時）・メモ雛形をフォームに反映すること
6. 保存ボタンをタップし、すべての必須項目が入力されている場合、支出データをlocalStorageに保存すること
7. 必須項目（日付・金額・区分・サブ区分）が未入力の場合、保存を拒否し該当項目をハイライト表示すること
8. 金額が0以下の場合、バリデーションエラーを表示すること
9. 満足度に値が入力されており、かつ1〜5以外の場合、バリデーションエラーを表示すること
10. 入力項目として以下を提供すること：日付（必須）、金額（必須、整数、1以上）、区分（必須）、サブ区分（必須）、メモ（任意、最大200文字【固定】）、満足度（任意、整数1〜5またはnull）

#### 頻出金額候補の仕様
- 対象期間: 直近90日【固定】
- 候補件数: 上位5件【固定】
- 抽出ロジック: 金額が同一のものを頻度カウントし、頻度上位を抽出
- 更新タイミング: 支出の保存成功時に再計算
- カテゴリ別候補: MVPでは実装しない（全カテゴリ横断）

### 要件2: 区分・サブ区分の管理
**目的:** 支出を適切な区分・サブ区分に分類し、集計や分析をしやすくする

#### 受け入れ条件
1. 区分として「交通費（transport）」と「交際費（social）」の2種類を提供すること【固定】
2. 区分「交通費」選択時、サブ区分として「電車/バス/タクシー/駐車場/その他」を表示すること【固定】
3. 区分「交際費」選択時、サブ区分として「食事/カフェ/飲み/カラオケ/部屋代/その他」を表示すること【固定】
4. 区分が変更された際、サブ区分の選択肢を対応するものに更新すること

### 要件3: 支出一覧の表示
**目的:** 記録した支出を一覧で確認し、過去の支出履歴を把握できるようにする

#### 受け入れ条件
1. 支出一覧を日付降順（最新が上）で表示すること
2. 各支出について以下の項目を表示すること：日付、金額、区分・サブ区分、メモ（省略表示）、満足度（設定されている場合のみ表示）
3. 月フィルタが選択された際、選択された月の支出のみを表示すること
4. 区分フィルタが選択された際、選択された区分の支出のみを表示すること
5. サブ区分フィルタが選択された際、選択されたサブ区分の支出のみを表示すること
6. フィルタオプションとして「今月」「先月」「月指定」を提供すること

### 要件4: 支出の編集
**目的:** 記録した支出を修正し、入力ミスを訂正できるようにする

#### 受け入れ条件
1. 一覧から支出をタップした際、編集画面（またはモーダル）を表示すること
2. 編集画面で全フィールド（日付・金額・区分・サブ区分・メモ・満足度）の変更を許可すること
3. 編集を保存した際、変更をlocalStorageに反映すること
4. 編集が完了した際、一覧画面に戻り更新された内容を表示すること
5. 編集時にバリデーションエラーがある場合、エラーを表示し保存を拒否すること

### 要件5: 支出の削除
**目的:** 不要な支出を削除し、データを整理できるようにする

#### 受け入れ条件
1. 削除ボタンをタップした際、確認ダイアログを表示すること
2. 確認ダイアログで「削除」を選択した際、該当の支出をlocalStorageから削除すること
3. 削除が完了した際、一覧から該当の支出を除去すること
4. 確認ダイアログで「キャンセル」を選択した場合、削除を中止し元の画面に戻ること

### 要件6: 月次・期間集計
**目的:** 支出の集計を確認し、月ごとの支出状況を把握できるようにする

#### 受け入れ条件
1. 今月の交通費合計・交際費合計・総合計を表示すること
2. サブ区分別の内訳合計を表示すること
3. 期間指定した際、開始日〜終了日の範囲で集計を表示すること
4. サブ区分別内訳の総和が該当区分の合計と一致することを保証すること

### 要件7: 満足度の集計・分析
**目的:** 満足度データを活用し、支出の質を振り返れるようにする

#### 受け入れ条件
1. 集計画面で、対象期間内の満足度の平均値を表示すること（満足度が設定された支出のみ対象）
2. 集計画面で、満足度の分布（1〜5それぞれの件数）を表示すること
3. 集計画面で、満足度の期間内推移を表示すること（日別または週別）
4. サブ区分別の平均満足度を表示すること
5. 満足度が未設定（null）の支出は、平均計算の母数から除外すること

### 要件8: 気づき機能（軽量分析）
**目的:** 支出パターンの気づきを得て、支出の傾向を把握し改善に活かせるようにする

#### 受け入れ条件
1. 今月の交通費に占めるタクシー比率を表示すること
2. 交際費合計が多い日のTOP3を表示すること【固定: 3件】
3. 今週と先週の週次平均比較を表示すること
4. 内訳の偏りを表示すること（例：「食事が交際費のX%」）

### 要件9: テンプレート管理
**目的:** よく使う入力パターンをテンプレとして保存し、繰り返しの入力を効率化する

#### 受け入れ条件
1. テンプレ追加ボタンをタップした際、テンプレ作成フォームを表示すること
2. テンプレに以下の項目を設定できること：表示名（必須）、区分（必須）、サブ区分（必須）、金額（任意）、メモ雛形（任意）
3. テンプレを編集した際、変更をlocalStorageに保存すること
4. テンプレを削除した際、確認後にlocalStorageから削除すること
5. テンプレの並び順を変更できる機能を提供すること

### 要件10: CSV出力
**目的:** 支出データをCSV形式でエクスポートし、外部ツールで分析できるようにする

#### 受け入れ条件
1. CSV出力を選択した際、期間指定オプションを表示すること
2. CSV出力を実行した際、以下の列形式でファイルを生成すること【固定】：date,amount,category,subcategory,memo,satisfaction
3. 満足度が未設定の場合、CSVの該当列は空文字とすること
4. 生成したCSVファイルをダウンロードとして提供すること
5. 指定期間内のデータのみをCSVに含めること

### 要件11: JSONバックアップ
**目的:** すべてのデータをJSONでバックアップし、端末変更やデータ消失に備える

#### 受け入れ条件
1. JSONバックアップを選択した際、以下を含むJSONファイルを生成すること：全支出データ（満足度を含む）、テンプレ、設定、スキーマバージョン
2. 生成したJSONファイルをダウンロードとして提供すること
3. バックアップファイルに適切なファイル名（日時を含む）を付与すること

### 要件12: JSON復元（全削除置き換え）
**目的:** バックアップからデータを復元し、データを別端末に移行したり消失時に復旧できるようにする

#### 受け入れ条件
1. JSON復元を選択した際、ファイル選択ダイアログを表示すること
2. JSONファイルを選択した際、ファイル形式とスキーマバージョンを検証すること
3. JSONファイルの形式が不正な場合、エラーメッセージを表示し復元を中止すること
4. JSONが有効な場合、「現在のデータが全削除されます」の確認ダイアログを表示すること
5. 復元を確認した際、現在のデータを全削除しJSONの内容で置き換えること
6. 復元が完了した際、成功メッセージを表示すること

### 要件13: 全削除機能
**目的:** すべてのデータを削除し、アプリをリセットできるようにする

#### 受け入れ条件
1. 全削除を選択した際、警告メッセージ付きの確認ダイアログを表示すること
2. 確認ダイアログで全削除を承認した際、localStorageからすべてのデータを削除すること
3. 確認ダイアログでキャンセルを選択した場合、全削除を中止すること

### 要件14: PWA対応
**目的:** アプリをスマホのホーム画面に追加してオフラインでも使えるようにし、いつでもどこでも支出を記録できるようにする

#### 受け入れ条件
1. Web App Manifestを提供し、ホーム画面への追加を可能にすること
2. Service Workerを実装し、オフラインでも基本機能を動作させること
3. オフライン状態において、追加・一覧・編集・削除・集計機能を動作させること
4. 初回ロード後にアプリのリソースをキャッシュすること

### 要件15: データ保存とストレージ
**目的:** データを端末内に安全に保存し、プライバシーを守り外部送信を行わない

#### 受け入れ条件
1. すべてのデータをlocalStorageに保存すること
2. 外部サーバーへデータを送信しないこと
3. 設定画面にデータ消失リスク（ブラウザデータ削除等）を明記すること
4. 保存に失敗した場合、ユーザーにエラーを明確に通知すること

### 要件16: UI/UX基本要件
**目的:** スマホで快適に操作でき、ストレスなく継続利用できるようにする

#### 受け入れ条件
1. スマホ優先のレスポンシブデザインを採用すること
2. フッタタブ等で追加画面へすぐ戻れる導線を常設すること
3. 適切なタップ領域サイズを確保すること
4. 数百〜数千件のデータでも体感待ちなしで一覧・集計を表示すること
5. キーボード操作に対応すること

---

## 非機能要件

### パフォーマンス
- 一覧・集計表示は体感待ちなし（想定データ量：数百〜数千件）
- 追加操作は3〜6タップ程度、平均10秒以内で完了できる導線

### 信頼性
- 保存失敗時はユーザーに明確に通知
- データ整合性を保証（集計の総和が一致すること等）

### プライバシー・セキュリティ
- データは端末内（localStorage）のみに保存
- 外部への通信・データ送信は行わない

### アクセシビリティ
- 適切なタップ領域の確保
- フォーカス管理
- 最低限のキーボード操作対応

### 対応環境
- スマホ優先（iOS Safari / Android Chrome）
- PCブラウザ（Chrome等）は補助

---

## データモデル概要

### Expense（支出）
- id: UUID（必須）- 一意識別子
- date: string YYYY-MM-DD（必須）- 支出日
- amount: integer（必須）- 金額（1以上）
- category: string（必須）- 区分（transport / social）
- subcategory: string（必須）- サブ区分
- memo: string または null（任意）- メモ（最大200文字【固定】）
- satisfaction: integer 1-5 または null（任意）- 満足度
- created_at: string ISO8601（必須）- 作成日時
- updated_at: string ISO8601（必須）- 更新日時

### Template（テンプレ）
- id: UUID（必須）- 一意識別子
- name: string（必須）- 表示名
- category: string（必須）- 区分
- subcategory: string（必須）- サブ区分
- amount: integer または null（任意）- 金額
- memo_template: string または null（任意）- メモ雛形
- sort_order: integer（必須）- 並び順
- created_at: string ISO8601（必須）- 作成日時
- updated_at: string ISO8601（必須）- 更新日時

### Settings（設定）
- last_used_category: string - 前回使用した区分
- last_used_subcategory: string - 前回使用したサブ区分
- last_used_memo: string - 前回使用したメモ
- frequent_amount_window_days: integer - 頻出金額の対象期間（日数）【固定: 90】
- frequent_amount_limit: integer - 頻出金額の候補件数【固定: 5】
- week_start: integer - 週の開始曜日（0=日曜、1=月曜...）【初期値: 1】
- schema_version: integer - データスキーマのバージョン

---

## スコープ外（MVP）
- クラウド同期/ログイン機能
- レシート撮影・OCR
- 複数通貨・複数ユーザー
- 高度な検索（全文検索、複雑なタグフィルタ）
- カテゴリ別の頻出金額候補
